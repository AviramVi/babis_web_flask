{% extends "base.html" %}

{% block content %}
<div class="billing-container">
    <div class="billing-header">
        <h1 class="page-title">חיובים</h1>
        
        <div class="month-year-selector">
            <form method="get" id="monthYearForm">
                <div class="select-container">
                    <select name="month" id="monthSelect" class="month-dropdown">
                        {% for month in hebrew_months %}
                            <option value="{{ month.value }}" 
                                    {% if month.value|int == selected_month %}selected{% endif %}>
                                {{ month.display }}
                            </option>
                        {% endfor %}
                    </select>
                    
                    <select name="year" id="yearSelect" class="year-dropdown">
                        {% for year in years %}
                            <option value="{{ year }}" 
                                    {% if year == selected_year %}selected{% endif %}>
                                {{ year }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
    </div>

    <div class="table-wrapper">
        <table class="billing-table">
            <thead>
                <tr>
                    <th class="header-cell index-column">#</th>
                    {% for header in headers %}
                        <th class="header-cell">{{ header }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody id="billingTableBody">
                <tr>
                    <td colspan="{{ headers|length + 1 }}" class="no-data">טוען נתונים...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="billing-actions">
        <a href="{{ url_for('dashboard') }}" class="btn btn-back">חזרה</a>
        <button class="btn btn-export">ייצוא לאקסל</button>
        <button id="toggleDebug" class="btn btn-debug" onclick="toggleDebug()">הצג מידע ניפוי</button>
    </div>
    
    <div id="debugPanel" class="debug-panel" style="display: none; margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; direction: ltr; text-align: left;">
        <h3>Debug Information</h3>
        <div id="debugContent">
            <!-- Debug information will be inserted here -->
        </div>
    </div>
</div>

<style>
.billing-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    direction: rtl;
}

.billing-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 20px;
}

.page-title {
    margin: 0;
    color: #2196F3;
    font-size: 2.5em;
}

.month-year-selector {
    display: flex;
    align-items: center;
    gap: 10px;
}

.select-container {
    display: flex;
    gap: 10px;
}

.month-dropdown,
.year-dropdown {
    padding: 10px 15px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: white;
    color: #333;
    cursor: pointer;
    min-width: 120px;
    text-align: center;
}

.month-dropdown:hover,
.year-dropdown:hover {
    background-color: #f5f5f5;
}

.month-dropdown:focus,
.year-dropdown:focus {
    outline: none;
    border-color: #2196F3;
    box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
}

.table-wrapper {
    width: 100%;
    overflow-x: auto;
    margin: 20px 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.billing-table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
}

.billing-table th,
.billing-table td {
    padding: 12px 15px;
    text-align: center;
    border: 1px solid #ddd;
}

.billing-table th {
    background-color: #f8f9fa;
    font-weight: bold;
    color: #333;
}

.billing-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.billing-table tr:hover {
    background-color: #f1f1f1;
}

.index-column {
    width: 50px;
    text-align: center;
}

.number-cell {
    text-align: center;
    min-width: 80px;
}

.no-data {
    text-align: center;
    padding: 20px;
    color: #6c757d;
    font-style: italic;
}

.billing-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 24px;
}

.btn {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
    text-decoration: none;
}

.btn-back {
    background-color: #6c757d;
    color: white;
}

.btn-back:hover {
    background-color: #5a6268;
}

.btn-export {
    background-color: #28a745;
    color: white;
}

.btn-export:hover {
    background-color: #218838;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .billing-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .select-container {
        width: 100%;
    }
    
    .month-dropdown,
    .year-dropdown {
        flex: 1;
    }
}
</style>

<script>
// Global variable to store the current billing data
let billingData = [];

// Function to load billing data based on selected month and year
async function loadBillingData() {
    debugLog('loadBillingData called');
    
    // Get the select elements and table body
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const tableBody = document.getElementById('billingTableBody');
    
    if (!monthSelect || !yearSelect || !tableBody) {
        debugLog('Required elements not found', { 
            monthSelect: !!monthSelect, 
            yearSelect: !!yearSelect, 
            tableBody: !!tableBody 
        });
        return;
    }
    
    const month = monthSelect.value;
    const year = yearSelect.value;
    const headers = Array.from(document.querySelectorAll('th')).map(th => th.textContent);
    
    debugLog('Loading data for:', { month, year });
    
    // Show loading message
    tableBody.innerHTML = `
        <tr>
            <td colspan="${headers.length + 1}" class="no-data loading">טוען נתונים...</td>
        </tr>`;
    
    try {
        debugLog(`Fetching billing data for ${month}/${year}`);
        const apiUrl = `/api/billing?month=${month}&year=${year}`;
        debugLog('API URL:', apiUrl);
        
        // Show loading state
        tableBody.innerHTML = `
            <tr>
                <td colspan="${headers.length + 1}" class="no-data loading">טוען נתונים...</td>
            </tr>`;
        
        // Call our API endpoint to get billing data
        debugLog('Sending fetch request...');
        const startTime = performance.now();
        
        const response = await fetch(apiUrl, {
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            },
            cache: 'no-store',
            credentials: 'same-origin'  // Include cookies for session
        });
        
        const endTime = performance.now();
        const fetchTime = (endTime - startTime).toFixed(2);
        debugLog(`Fetch completed in ${fetchTime}ms`);
        debugLog('Response status:', { status: response.status, statusText: response.statusText });
        
        if (!response.ok) {
            const errorText = await response.text();
            const errorDetails = {
                status: response.status,
                statusText: response.statusText,
                headers: Object.fromEntries(response.headers.entries()),
                body: errorText,
                fetchTime: `${fetchTime}ms`
            };
            debugLog('API Error Response:', errorDetails);
            throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
        }
        
        debugLog('Parsing response as JSON...');
        const data = await response.json();
        debugLog('Received data:', data);
        
            // Check if we got an error message from the API
            if (data && data.error) {
                debugLog('API returned error:', data.error);
                throw new Error(data.error);
            }
            
            // The data should be either an array or an object with a data property
            if (!Array.isArray(data) && !(data && typeof data === 'object' && 'data' in data)) {
                debugLog('Unexpected data format received:', data);
                throw new Error('Unexpected data format received from server');
            }
        
        debugLog(`Successfully received ${data.length} billing records`);
        
        // Store the data
        billingData = data;
        
        // Update the URL without reloading the page
        const newUrl = `${window.location.pathname}?month=${month}&year=${year}`;
        window.history.pushState({ path: newUrl }, '', newUrl);
        
        // Log the raw response for debugging
        console.log('Raw API response:', data);
        
        try {
            // First, try to parse the response if it's a string
            let responseData = data;
            if (typeof data === 'string') {
                try {
                    responseData = JSON.parse(data);
                } catch (e) {
                    console.error('Failed to parse response as JSON:', e);
                    throw new Error('Invalid response format from server');
                }
            }
            
            // Check for the standard response format {status: 'success', data: [...]}
            if (responseData && typeof responseData === 'object') {
                if (responseData.status === 'success' && Array.isArray(responseData.data)) {
                    console.log(`Rendering ${responseData.data.length} records from response.data`);
                    if (responseData.data.length > 0) {
                        console.log('First record sample:', responseData.data[0]);
                    }
                    renderBillingData(responseData.data);
                    return;
                } 
                // If data is directly in the response as an array
                else if (Array.isArray(responseData)) {
                    console.log(`Rendering ${responseData.length} records from direct array`);
                    if (responseData.length > 0) {
                        console.log('First record sample:', responseData[0]);
                    }
                    renderBillingData(responseData);
                    return;
                }
            }
            
            console.error('Unexpected response format:', responseData);
            throw new Error('Invalid data format received from server');
            
        } catch (error) {
            console.error('Error processing response:', error);
            throw new Error('Failed to process server response: ' + error.message);
        }
    } catch (error) {
        const errorDetails = {
            message: error.message,
            name: error.name,
            stack: error.stack
        };
        debugLog('Error in loadBillingData:', errorDetails);
        
        const errorMessage = error.message || 'נסה שוב מאוחר יותר';
        
        tableBody.innerHTML = `
            <tr>
                <td colspan="${document.querySelectorAll('th').length + 1}" class="no-data error">
                    שגיאה בטעינת הנתונים: ${errorMessage}
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        לחץ על "הצג מידע ניפוי" לפרטים נוספים
                    </div>
                </td>
            </tr>`;
    }
}

// Function to render billing data in the table
function renderBillingData(data) {
    console.log('renderBillingData called with data:', data);
    
    const tableBody = document.getElementById('billingTableBody');
    const headers = Array.from(document.querySelectorAll('th')).map(th => th.textContent);
    
    if (!tableBody) {
        console.error('Table body element not found');
        return;
    }
    
    try {
        // Clear the table body first
        tableBody.innerHTML = '';
        
        if (!data) {
            throw new Error('No data provided to renderBillingData');
        }
        
        // Ensure data is an array
        const records = Array.isArray(data) ? data : [data];
        
        if (records.length === 0) {
            throw new Error('No records found in the data');
        }
        
        // Log the first record for debugging
        console.log('First record to render:', records[0]);
        
        // Render the records
        records.forEach((record, index) => {
            const row = document.createElement('tr');
            
            // Add index cell
            const indexCell = document.createElement('td');
            indexCell.textContent = index + 1;
            indexCell.className = 'index-column';
            row.appendChild(indexCell);
            
            // Define the exact column order we expect
            const columnOrder = [
                'לקוח',
                'סהכ שעות',
                'לפי מדריך',
                'מדריך',
                'תמחור שעה',
                'הנחה %',
                'סיכום'
            ];
            
            // Add data cells in the exact order defined above
            columnOrder.forEach(header => {
                const cell = document.createElement('td');
                let value = '';
                
                // Map the data based on the column
                if (header === 'לקוח') {
                    value = record['לקוח'] || '';
                    cell.className = 'client-cell';
                } else if (header === 'סהכ שעות') {
                    value = record['סהכ שעות'] !== undefined ? formatNumber(record['סהכ שעות'], 2) : '';
                    cell.className = 'number-cell';
                } else if (header === 'לפי מדריך') {
                    value = record['לפי מדריך'] || '';
                    cell.className = 'instructor-hours-cell';
                    cell.style.whiteSpace = 'pre-line';
                } else if (header === 'מדריך') {
                    value = record['מדריך'] || '';
                    cell.className = 'instructor-names-cell';
                    cell.style.color = '#2E7D32'; // Dark green
                    cell.style.fontWeight = '500';
                    cell.style.whiteSpace = 'pre-line';
                } else if (header === 'תמחור שעה') {
                    // Ensure we have a number, default to 350 if not set
                    let rateValue = parseFloat(record['תמחור שעה']);
                    if (isNaN(rateValue)) rateValue = 350;
                    // Format as currency
                    value = `₪${formatNumber(rateValue, 2)}`;
                    cell.className = 'number-cell';
                    // Store the raw number value in a data attribute for calculations
                    cell.dataset.rawValue = rateValue;
                } else if (header === 'הנחה %') {
                    // Ensure we have a number, default to 0 if invalid
                    let discountValue = parseFloat(record['הנחה %']);
                    if (isNaN(discountValue)) discountValue = 0;
                    // Format as percentage with 0 decimal places
                    value = `${Math.round(discountValue)}%`;
                    cell.className = 'number-cell';
                    // Store the raw number value in a data attribute for calculations
                    cell.dataset.rawValue = discountValue;
                } else if (header === 'סיכום') {
                    value = record['סיכום'] ? `₪${formatNumber(record['סיכום'], 2)}` : '';
                    cell.className = 'number-cell total-cell';
                    cell.style.fontWeight = 'bold';
                } else {
                    value = record[header] || '';
                }
                
                cell.textContent = value;
                row.appendChild(cell);
            });
            
            tableBody.appendChild(row);
        });
        
    } catch (error) {
        console.error('Error in renderBillingData:', error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="${headers.length}" class="no-data error">
                    שגיאה: ${error.message || 'שגיאה בטעינת הנתונים'}
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        ${error.message || 'An error occurred while loading data'}
                    </div>
                </td>
            </tr>`;
    }
    
    if (data.length === 0) {
        debugLog('No data available for the selected period');
        tableBody.innerHTML = `
            <tr>
                <td colspan="${headers.length}" class="no-data">
                    לא נמצאו נתונים לחודש הנבחר
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        No records found for the selected period
                    </div>
                </td>
            </tr>`;
        return;
    }
    
    // Clear the table body
    tableBody.innerHTML = '';
    
    // Add a row for each client
    data.forEach((client, index) => {
        const row = document.createElement('tr');
        
        // Add index cell
        const indexCell = document.createElement('td');
        indexCell.textContent = index + 1;
        indexCell.className = 'index-column';
        row.appendChild(indexCell);
        
        // Define the exact column order we expect
        const columnOrder = [
            'לקוח',
            'סהכ שעות',
            'לפי מדריך',
            'מדריך',
            'תמחור שעה',
            'הנחה %',
            'סיכום'
        ];
        
        // Add data cells in the exact order defined above
        columnOrder.forEach(header => {
            const cell = document.createElement('td');
            let value = '';
            
            // Map the data based on the column
            if (header === 'לקוח') {
                value = client['לקוח'] || '';
                cell.className = 'client-cell';
            } else if (header === 'סהכ שעות') {
                value = client['סהכ שעות'] !== undefined ? formatNumber(client['סהכ שעות'], 2) : '';
                cell.className = 'number-cell';
            } else if (header === 'לפי מדריך') {
                value = client['לפי מדריך'] || '';
                cell.className = 'instructor-hours-cell';
                cell.style.whiteSpace = 'pre-line';
            } else if (header === 'מדריך') {
                value = client['מדריך'] || '';
                cell.className = 'instructor-names-cell';
                cell.style.color = '#2E7D32'; // Dark green
                cell.style.fontWeight = '500';
                cell.style.whiteSpace = 'pre-line';
            } else if (header === 'תמחור שעה') {
                // Ensure we have a number, default to 350 if not set
                let rateValue = parseFloat(client['תמחור שעה']);
                if (isNaN(rateValue)) rateValue = 350;
                // Format as currency
                value = `₪${formatNumber(rateValue, 2)}`;
                cell.className = 'number-cell';
                // Store the raw number value in a data attribute for calculations
                cell.dataset.rawValue = rateValue;
            } else if (header === 'הנחה %') {
                // Ensure we have a number, default to 0 if invalid
                let discountValue = parseFloat(client['הנחה %']);
                if (isNaN(discountValue)) discountValue = 0;
                // Format as percentage with 0 decimal places
                value = `${Math.round(discountValue)}%`;
                cell.className = 'number-cell';
                // Store the raw number value in a data attribute for calculations
                cell.dataset.rawValue = discountValue;
            } else if (header === 'סיכום') {
                value = client['סיכום'] ? `₪${formatNumber(client['סיכום'], 2)}` : '';
                cell.className = 'number-cell total-cell';
                cell.style.fontWeight = 'bold';
            } else {
                value = client[header] || '';
            }
            
            cell.textContent = value;
            
            // Add event handlers for rate cells
            if (header === 'תמחור שעה') {
                cell.addEventListener('click', function() {
                    // Make cell editable
                    this.contentEditable = true;
                    // Show raw value without currency symbol when editing
                    this.textContent = this.dataset.rawValue || '350';
                    // Select all text for easy editing
                    const range = document.createRange();
                    range.selectNodeContents(this);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });
                
                // Handle blur event
                cell.addEventListener('blur', function() {
                    let value = parseFloat(this.textContent.trim()) || 0;
                    // Ensure value is not negative
                    value = Math.max(0, value);
                    // Update display with currency symbol
                    this.textContent = `₪${formatNumber(value, 2)}`;
                    // Store raw value for calculations
                    this.dataset.rawValue = value;
                    this.contentEditable = false;
                    // Update total
                    updateTotal(row);
                });
                
                // Handle keydown for numbers and navigation
                cell.addEventListener('keydown', function(e) {
                    // Allow: backspace, delete, tab, escape, enter, numbers, decimal point
                    if ([46, 8, 9, 27, 13, 110, 190].includes(e.keyCode) ||
                        // Allow: Ctrl+A
                        (e.keyCode === 65 && e.ctrlKey === true) ||
                        // Allow: home, end, left, right
                        (e.keyCode >= 35 && e.keyCode <= 39) ||
                        // Allow: numbers
                        (e.keyCode >= 48 && e.keyCode <= 57) ||
                        // Allow: numpad numbers
                        (e.keyCode >= 96 && e.keyCode <= 105)) {
                        // Let it happen, don't do anything
                        return;
                    }
                    
                    // If it's not a number, prevent the keypress
                    if ((e.keyCode < 48 || e.keyCode > 57) && (e.keyCode < 96 || e.keyCode > 105) && e.keyCode !== 190 && e.keyCode !== 110) {
                        e.preventDefault();
                    }
                    
                    // Handle Enter key to save
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            }
            
            // Add event handlers for discount cells
            if (header === 'הנחה %') {
                cell.addEventListener('click', function() {
                    // Make cell editable
                    this.contentEditable = true;
                    // Show raw value without % when editing
                    this.textContent = this.dataset.rawValue || '0';
                    // Select all text for easy editing
                    const range = document.createRange();
                    range.selectNodeContents(this);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });
                
                // Handle blur event
                cell.addEventListener('blur', function() {
                    let value = parseFloat(this.textContent.trim()) || 0;
                    // Ensure value is between 0 and 100
                    value = Math.min(100, Math.max(0, value));
                    // Update display with %
                    this.textContent = `${Math.round(value)}%`;
                    // Store raw value for calculations
                    this.dataset.rawValue = value;
                    this.contentEditable = false;
                    // Update total
                    updateTotal(row);
                });
                
                // Handle keydown for numbers and navigation
                cell.addEventListener('keydown', function(e) {
                    // Allow: backspace, delete, tab, escape, enter, numbers, decimal point
                    if ([46, 8, 9, 27, 13, 110, 190].includes(e.keyCode) ||
                        // Allow: Ctrl+A
                        (e.keyCode === 65 && e.ctrlKey === true) ||
                        // Allow: home, end, left, right
                        (e.keyCode >= 35 && e.keyCode <= 39) ||
                        // Allow: numbers
                        (e.keyCode >= 48 && e.keyCode <= 57) ||
                        // Allow: numpad numbers
                        (e.keyCode >= 96 && e.keyCode <= 105)) {
                        // Let it happen, don't do anything
                        return;
                    }
                    
                    // If it's not a number, prevent the keypress
                    if ((e.keyCode < 48 || e.keyCode > 57) && (e.keyCode < 96 || e.keyCode > 105)) {
                        e.preventDefault();
                    }
                    
                    // Handle Enter key to save
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            }
            
            row.appendChild(cell);
        });
        
        tableBody.appendChild(row);
        
        // Function to update the total for a row
        function updateTotal(row) {
            try {
                const hoursCell = row.querySelector('td:nth-child(3)'); // סהכ שעות
                const rateCell = row.querySelector('td:nth-child(6)');  // תמחור שעה
                const discountCell = row.querySelector('td:nth-child(7)'); // הנחה %
                const totalCell = row.querySelector('td:nth-child(8)'); // סיכום
                
                if (hoursCell && rateCell && discountCell && totalCell) {
                    // Get hours from the cell text
                    const hours = parseFloat(hoursCell.textContent) || 0;
                    
                    // Get rate from data attribute if available, otherwise from cell text
                    let rate = parseFloat(rateCell.dataset.rawValue);
                    if (isNaN(rate)) {
                        rate = parseFloat(rateCell.textContent.replace(/[^0-9.-]+/g,"")) || 0;
                    }
                    
                    // Get discount from data attribute if available, otherwise from cell text
                    let discount = parseFloat(discountCell.dataset.rawValue);
                    if (isNaN(discount)) {
                        discount = parseFloat(discountCell.textContent) || 0;
                    }
                    
                    debugLog('Updating total with values:', { hours, rate, discount });
                    
                    // Calculate subtotal
                    const subtotal = hours * rate;
                    // Apply discount
                    const total = subtotal * (1 - (discount / 100));
                    
                    // Update total cell
                    totalCell.textContent = `₪${formatNumber(total, 2)}`;
                    
                    // Update the cell's data attributes if they don't have them
                    if (!rateCell.dataset.rawValue) {
                        rateCell.dataset.rawValue = rate;
                    }
                    if (!discountCell.dataset.rawValue) {
                        discountCell.dataset.rawValue = discount;
                    }
                }
            } catch (error) {
                console.error('Error updating total:', error);
            }
        }
    });
}

// Helper function to format numbers with specific decimal places
function formatNumber(num, decimals) {
    if (num === undefined || num === null || num === '') return '';
    const number = parseFloat(num);
    return isNaN(number) ? '' : number.toLocaleString(undefined, {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

// Helper function to format cell content (for future use)
function formatCell(value) {
    if (value === undefined || value === null) return '';
    return String(value).replace(/\n/g, '<br>');
}

// Helper function to format currency values (for future use)
function formatCurrency(value) {
    if (value === undefined || value === null) return '';
    const num = parseFloat(value);
    return isNaN(num) ? '' : `₪${num.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

// Helper function to format percentage values (for future use)
function formatPercentage(value) {
    if (value === undefined || value === null) return '';
    const num = parseFloat(value);
    return isNaN(num) ? '' : `${num}%`;
}

// Debug functions
function debugLog(message, data = null) {
    const timestamp = new Date().toISOString();
    const logEntry = document.createElement('div');
    logEntry.className = 'debug-entry';
    
    if (data) {
        logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
    } else {
        logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
    }
    
    const debugContent = document.getElementById('debugContent');
    if (debugContent) {
        debugContent.prepend(logEntry);
        // Keep only the last 50 log entries
        while (debugContent.children.length > 50) {
            debugContent.removeChild(debugContent.lastChild);
        }
    }
    
    // Also log to console
    if (data) {
        console.log(`[${timestamp}] ${message}`, data);
    } else {
        console.log(`[${timestamp}] ${message}`);
    }
}

function toggleDebug() {
    const debugPanel = document.getElementById('debugPanel');
    const toggleButton = document.getElementById('toggleDebug');
    
    if (debugPanel.style.display === 'none') {
        debugPanel.style.display = 'block';
        toggleButton.textContent = 'הסתר מידע ניפוי';
    } else {
        debugPanel.style.display = 'none';
        toggleButton.textContent = 'הצג מידע ניפוי';
    }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    debugLog('Billing page loaded');
    
    // Get the select elements
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    
    // Log initial values
    debugLog('Initial month:', monthSelect ? monthSelect.value : 'not found');
    debugLog('Initial year:', yearSelect ? yearSelect.value : 'not found');
    
    // Add event listeners for the dropdowns
    if (monthSelect) {
        monthSelect.addEventListener('change', loadBillingData);
        debugLog('Added change listener to month select');
    } else {
        debugLog('Month select element not found', { error: 'element_not_found', id: 'monthSelect' });
    }
    
    if (yearSelect) {
        yearSelect.addEventListener('change', loadBillingData);
        debugLog('Added change listener to year select');
    } else {
        debugLog('Year select element not found', { error: 'element_not_found', id: 'yearSelect' });
    }
    
    // Set up event listeners for the export button
    const exportBtn = document.querySelector('.btn-export');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            alert('ייצוא לאקסל יוטמע בהמשך');
            // TODO: Implement export to Excel functionality
        });
    } else {
        debugLog('Export button not found', { error: 'element_not_found', class: 'btn-export' });
    }
    
    // Remove the onchange attributes from the HTML to prevent duplicate handlers
    if (monthSelect) monthSelect.removeAttribute('onchange');
    if (yearSelect) yearSelect.removeAttribute('onchange');
    
    // Initial data load
    debugLog('Loading initial billing data...');
    loadBillingData();
});
</script>
{% endblock %}