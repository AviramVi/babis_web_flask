{% extends "base.html" %}

{% block content %}
<div class="billing-container">
    <div class="billing-header">
        <h1 class="page-title">חיובים</h1>
        
        <div class="month-year-selector">
            <form method="get" id="monthYearForm">
                <div class="select-container">
                    <select name="month" id="monthSelect" class="month-dropdown">
                        {% for month in hebrew_months %}
                            <option value="{{ month.value }}" 
                                    {% if month.value|int == selected_month %}selected{% endif %}>
                                {{ month.display }}
                            </option>
                        {% endfor %}
                    </select>
                    
                    <select name="year" id="yearSelect" class="year-dropdown">
                        {% for year in years %}
                            <option value="{{ year }}" 
                                    {% if year == selected_year %}selected{% endif %}>
                                {{ year }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
    </div>

    <div class="table-wrapper">
        <table class="billing-table">
            <thead>
                <tr>
                    <th class="header-cell index-column">#</th>
                    {% for header in headers %}
                        <th class="header-cell">{{ header }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody id="billingTableBody">
                <tr>
                    <td colspan="{{ headers|length + 1 }}" class="no-data">טוען נתונים...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="billing-actions">
        <a href="{{ url_for('dashboard') }}" class="btn btn-back">חזרה</a>
        <button class="btn btn-export">ייצוא לאקסל</button>
        <button id="toggleDebug" class="btn btn-debug" onclick="toggleDebug()">הצג מידע ניפוי</button>
    </div>
    
    <div id="debugPanel" class="debug-panel" style="display: none; margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; direction: ltr; text-align: left;">
        <h3>Debug Information</h3>
        <div id="debugContent">
            <!-- Debug information will be inserted here -->
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>
</div>

<!-- Client Events Modal -->
<div id="clientEventsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="clientEventsTitle">אירועים עבור לקוח</h2>
            <span class="close-btn" id="closeClientEvents">&times;</span>
        </div>
        <div class="modal-body">
            <div class="table-responsive">
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>כותרת</th>
                            <th>מדריך</th>
                            <th>תאריך</th>
                            <th>שעה</th>
                            <th>מס' שעות</th>
                        </tr>
                    </thead>
                    <tbody id="clientEventsBody">
                        <!-- Event rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button id="exportToHtml" class="btn btn-export">ייצוא ל-HTML</button>
            <button id="closeModalBtn" class="btn btn-secondary">סגור</button>
        </div>
    </div>
</div>

<style>
/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    direction: rtl;
    overflow: auto;
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 1000px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
    margin-bottom: 15px;
}

.modal-header h2 {
    margin: 0;
    color: #333;
    font-size: 1.5em;
}

.close-btn {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close-btn:hover,
.close-btn:focus {
    color: black;
    text-decoration: none;
}

.modal-body {
    margin-bottom: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-footer {
    display: flex;
    justify-content: flex-start;
    gap: 10px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

/* Events Table Styles */
.events-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.events-table th,
.events-table td {
    padding: 12px 15px;
    text-align: right;
    border-bottom: 1px solid #ddd;
}

.events-table th {
    background-color: #f8f9fa;
    font-weight: bold;
    color: #333;
    position: sticky;
    top: 0;
    background: #f1f1f1;
}

.events-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.events-table tr:hover {
    background-color: #f1f1f1;
}

/* Responsive Table */
.table-responsive {
    overflow-x: auto;
}

/* Loading spinner */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    border-top-color: #3498db;
    animation: spin 1s ease-in-out infinite;
    margin-right: 10px;
    vertical-align: middle;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    vertical-align: middle;
}

    /* Toast notification styles */
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #4CAF50;
        color: white;
        padding: 15px 25px;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    .toast.show {
        opacity: 1;
    }

    .toast.error {
        background-color: #f44336;
    }

.page-title {
    margin: 0;
    color: #2196F3;
    font-size: 2.5em;
}

.month-year-selector {
    display: flex;
    align-items: center;
    gap: 10px;
}

.select-container {
    display: flex;
    gap: 10px;
}

.month-dropdown,
.year-dropdown {
    padding: 10px 15px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: white;
    color: #333;
    cursor: pointer;
    min-width: 120px;
    text-align: center;
}

.month-dropdown:hover,
.year-dropdown:hover {
    background-color: #f5f5f5;
}

.month-dropdown:focus,
.year-dropdown:focus {
    outline: none;
    border-color: #2196F3;
    box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
}

.table-wrapper {
    width: 100%;
    overflow-x: auto;
    margin: 20px 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.billing-table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
}

.billing-table th,
.billing-table td {
    padding: 12px 15px;
    text-align: center;
    border: 1px solid #ddd;
}

.billing-table th {
    background-color: #f8f9fa;
    font-weight: bold;
    color: #333;
}

.billing-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.billing-table tr:hover {
    background-color: #f1f1f1;
}

.index-column {
    width: 50px;
    text-align: center;
}

.number-cell {
    text-align: left;
    direction: ltr;
    font-family: 'Courier New', monospace;
    padding: 8px 12px;
}

/* Client cell style */
.client-cell {
    font-weight: bold !important;
    color: #FF00FF !important; /* Bright magenta color */
}

/* Instructor hours cell style (לפי מדריך) */
.instructor-hours-cell {
    color: #2E7D32 !important; /* Dark green to match מדריך */
    font-weight: 500 !important;
    white-space: pre-line !important;
}

/* Hours total column (סהכ שעות) */
td:nth-child(3) {
    font-weight: bold !important;
    color: #FF00FF !important; /* Bright magenta color */
}

/* Total column (סיכום) */
td:last-child {
    font-weight: bold !important;
    color: #FF00FF !important; /* Bright magenta color */
}

.no-data {
    text-align: center;
    padding: 20px;
    color: #6c757d;
    font-style: italic;
}

.billing-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 24px;
}

.btn {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
    text-decoration: none;
}

.btn-back {
    background-color: #6c757d;
    color: white;
}

.btn-back:hover {
    background-color: #5a6268;
}

.btn-export {
    background-color: #28a745;
    color: white;
}

.btn-export:hover {
    background-color: #218838;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .billing-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .select-container {
        width: 100%;
    }
    
    .month-dropdown,
    .year-dropdown {
        flex: 1;
    }
}
</style>

<script>
// Global variable to store the current billing data
let billingData = [];

// Function to load billing data based on selected month and year
async function loadBillingData() {
    debugLog('loadBillingData called');
    
    // Get the select elements and table body
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const tableBody = document.getElementById('billingTableBody');
    
    if (!monthSelect || !yearSelect || !tableBody) {
        debugLog('Required elements not found', { 
            monthSelect: !!monthSelect, 
            yearSelect: !!yearSelect, 
            tableBody: !!tableBody 
        });
        return;
    }
    
    const month = monthSelect.value;
    const year = yearSelect.value;
    const headers = Array.from(document.querySelectorAll('th')).map(th => th.textContent);
    
    debugLog('Loading data for:', { month, year });
    
    // Show loading message
    tableBody.innerHTML = `
        <tr>
            <td colspan="${headers.length + 1}" class="no-data loading">טוען נתונים...</td>
        </tr>`;
    
    try {
        debugLog(`Fetching billing data for ${month}/${year}`);
        const apiUrl = `/api/billing?month=${month}&year=${year}`;
        debugLog('API URL:', apiUrl);
        
        // Call our API endpoint to get billing data
        debugLog('Sending fetch request...');
        const startTime = performance.now();
        
        const response = await fetch(apiUrl, {
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            },
            cache: 'no-store',
            credentials: 'same-origin'  // Include cookies for session
        });
        
        const endTime = performance.now();
        const fetchTime = (endTime - startTime).toFixed(2);
        debugLog(`Fetch completed in ${fetchTime}ms`);
        debugLog('Response status:', { status: response.status, statusText: response.statusText });
        
        if (!response.ok) {
            const errorText = await response.text();
            const errorDetails = {
                status: response.status,
                statusText: response.statusText,
                headers: Object.fromEntries(response.headers.entries()),
                body: errorText,
                fetchTime: `${fetchTime}ms`
            };
            debugLog('API Error Response:', errorDetails);
            throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
        }
        
        let responseData;
        try {
            responseData = await response.json();
            debugLog('API Response data:', responseData);
        } catch (e) {
            console.error('Failed to parse response as JSON:', e);
            throw new Error('Invalid JSON response from server');
        }
        
        // Process the response data
        let billingData = [];
        
        if (responseData && responseData.status === 'success' && Array.isArray(responseData.data)) {
            billingData = responseData.data;
        } else if (Array.isArray(responseData)) {
            billingData = responseData;
        } else {
            throw new Error('Invalid data format received from server');
        }
        
        // Render the billing data with the updated rates, discounts, and totals
        renderBillingData(billingData);
        
        // Update the URL without reloading the page
        const newUrl = `${window.location.pathname}?month=${month}&year=${year}`;
        window.history.pushState({ path: newUrl }, '', newUrl);
        
        debugLog('Billing data loaded and rendered successfully');
        
    } catch (error) {
        console.error('Error loading billing data:', error);
        debugLog('Error details:', { 
            error: error.toString(), 
            stack: error.stack,
            name: error.name
        });
        
        const errorMessage = error.message || 'נסה שוב מאוחר יותר';
        
        // Show error message in table
        tableBody.innerHTML = `
            <tr>
                <td colspan="${headers.length + 1}" class="no-data error">
                    שגיאה בטעינת הנתונים: ${errorMessage}
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        לחץ על "הצג מידע ניפוי" לפרטים נוספים
                    </div>
                </td>
            </tr>`;
    }
}

// Function to render billing data in the table
function renderBillingData(data) {
    console.log('renderBillingData called with data:', data);
    
    const tableBody = document.getElementById('billingTableBody');
    const headers = Array.from(document.querySelectorAll('th')).map(th => th.textContent);
    
    if (!tableBody) {
        console.error('Table body element not found');
        return;
    }
    
    try {
        // Clear the table body first
        tableBody.innerHTML = '';
        
        if (!data) {
            throw new Error('No data provided to renderBillingData');
        }
        
        // Ensure data is an array
        const records = Array.isArray(data) ? data : [data];
        
        if (records.length === 0) {
            throw new Error('No records found in the data');
        }
        
        // Log the first record for debugging
        console.log('First record to render:', records[0]);
        
        // Render the records
        records.forEach((record, index) => {
            const row = document.createElement('tr');
            
            // Add index cell
            const indexCell = document.createElement('td');
            indexCell.textContent = index + 1;
            indexCell.className = 'index-column';
            row.appendChild(indexCell);
            
            // Define the exact column order we expect
            const columnOrder = [
                'לקוח',
                'סהכ שעות',
                'לפי מדריך',
                'מדריך',
                'תמחור שעה',
                'הנחה %',
                'סיכום'
            ];
            
            // Add data cells in the exact order defined above
            columnOrder.forEach(header => {
                const cell = document.createElement('td');
                let value = '';
                
                // Map the data based on the column
                if (header === 'לקוח') {
                    value = record['לקוח'] || '';
                    cell.className = 'client-cell';
                } else if (header === 'סהכ שעות') {
                    value = record['סהכ שעות'] !== undefined ? formatNumber(record['סהכ שעות'], 2) : '';
                    cell.className = 'number-cell';
                } else if (header === 'לפי מדריך') {
                    value = record['לפי מדריך'] || '';
                    cell.className = 'instructor-hours-cell';
                    cell.style.whiteSpace = 'pre-line';
                } else if (header === 'מדריך') {
                    value = record['מדריך'] || '';
                    cell.className = 'instructor-names-cell';
                    cell.style.color = '#2E7D32'; // Dark green
                    cell.style.fontWeight = '500';
                    cell.style.whiteSpace = 'pre-line';
                } else if (header === 'תמחור שעה') {
                    // Ensure we have a number, default to 350 if not set
                    let rateValue = parseFloat(record['תמחור שעה']);
                    if (isNaN(rateValue)) rateValue = 350;
                    // Format as number
                    value = formatNumber(rateValue, 2);
                    cell.className = 'number-cell';
                    // Store the raw number value in a data attribute for calculations
                    cell.dataset.rawValue = rateValue;
                } else if (header === 'הנחה %') {
                    // Ensure we have a number, default to 0 if invalid
                    let discountValue = parseFloat(record['הנחה %']);
                    if (isNaN(discountValue)) discountValue = 0;
                    // Format as percentage with 0 decimal places
                    value = `${Math.round(discountValue)}%`;
                    cell.className = 'number-cell';
                    // Store the raw number value in a data attribute for calculations
                    cell.dataset.rawValue = discountValue;
                } else if (header === 'סיכום') {
                    value = record['סיכום'] ? `₪${formatNumber(record['סיכום'], 2)}` : '';
                    cell.className = 'number-cell total-cell';
                    cell.style.fontWeight = 'bold';
                } else {
                    value = record[header] || '';
                }
                
                cell.textContent = value;
                row.appendChild(cell);
            });
            
            tableBody.appendChild(row);
        });
        
    } catch (error) {
        console.error('Error in renderBillingData:', error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="${headers.length}" class="no-data error">
                    שגיאה: ${error.message || 'שגיאה בטעינת הנתונים'}
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        ${error.message || 'An error occurred while loading data'}
                    </div>
                </td>
            </tr>`;
    }
    
    if (data.length === 0) {
        debugLog('No data available for the selected period');
        tableBody.innerHTML = `
            <tr>
                <td colspan="${headers.length}" class="no-data">
                    לא נמצאו נתונים לחודש הנבחר
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        No records found for the selected period
                    </div>
                </td>
            </tr>`;
        return;
    }
    
    // Clear the table body
    tableBody.innerHTML = '';
    
    // Add a row for each client
    data.forEach((client, index) => {
        const row = document.createElement('tr');
        
        // Add index cell
        const indexCell = document.createElement('td');
        indexCell.textContent = index + 1;
        indexCell.className = 'index-column';
        row.appendChild(indexCell);
        
        // Define the exact column order we expect
        const columnOrder = [
            'לקוח',
            'סהכ שעות',
            'לפי מדריך',
            'מדריך',
            'תמחור שעה',
            'הנחה %',
            'סיכום'
        ];
        
        // Add data cells in the exact order defined above
        columnOrder.forEach(header => {
            const cell = document.createElement('td');
            let value = '';
            
            // Map the data based on the column
            if (header === 'לקוח') {
                value = client['לקוח'] || '';
                cell.className = 'client-cell';
            } else if (header === 'סהכ שעות') {
                value = client['סהכ שעות'] !== undefined ? formatNumber(client['סהכ שעות'], 2) : '';
                cell.className = 'number-cell';
            } else if (header === 'לפי מדריך') {
                value = client['לפי מדריך'] || '';
                cell.className = 'instructor-hours-cell';
                cell.style.whiteSpace = 'pre-line';
            } else if (header === 'מדריך') {
                value = client['מדריך'] || '';
                cell.className = 'instructor-names-cell';
                cell.style.color = '#2E7D32'; // Dark green
                cell.style.fontWeight = '500';
                cell.style.whiteSpace = 'pre-line';
            } else if (header === 'תמחור שעה') {
                // Ensure we have a number, default to 350 if not set
                let rateValue = parseFloat(client['תמחור שעה']);
                if (isNaN(rateValue)) rateValue = 350;
                // Format as number
                value = formatNumber(rateValue, 2);
                cell.className = 'number-cell';
                // Store the raw number value in a data attribute for calculations
                cell.dataset.rawValue = rateValue;
            } else if (header === 'הנחה %') {
                // Ensure we have a number, default to 0 if invalid
                let discountValue = parseFloat(client['הנחה %']);
                if (isNaN(discountValue)) discountValue = 0;
                // Format as percentage with 0 decimal places
                value = `${Math.round(discountValue)}%`;
                cell.className = 'number-cell';
                // Store the raw number value in a data attribute for calculations
                cell.dataset.rawValue = discountValue;
            } else if (header === 'סיכום') {
                value = client['סיכום'] ? formatNumber(client['סיכום'], 2) : '';
                cell.className = 'number-cell total-cell';
                cell.style.fontWeight = 'bold';
            } else {
                value = client[header] || '';
            }
            
            cell.textContent = value;
            
            // Add event handlers for rate cells
            if (header === 'תמחור שעה') {
                cell.addEventListener('click', function() {
                    // Make cell editable
                    this.contentEditable = true;
                    // Show raw value without currency symbol when editing
                    this.textContent = this.dataset.rawValue || '350';
                    // Select all text for easy editing
                    const range = document.createRange();
                    range.selectNodeContents(this);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });
                
                // Handle blur event
                cell.addEventListener('blur', async function() {
                    const clientName = row.querySelector('.client-cell').textContent.trim();
                    const monthSelect = document.getElementById('monthSelect');
                    const yearSelect = document.getElementById('yearSelect');
                    
                    let value = parseFloat(this.textContent.trim()) || 0;
                    // Ensure value is not negative
                    value = Math.max(0, value);
                    
                    // Store old value for potential rollback
                    const oldValue = this.dataset.rawValue || 0;
                    
                    // If value hasn't changed, just exit
                    if (value === parseFloat(oldValue)) {
                        this.contentEditable = false;
                        return;
                    }
                    
                    // Update display as number
                    this.textContent = formatNumber(value, 2);
                    // Store raw value for calculations
                    this.dataset.rawValue = value;
                    this.contentEditable = false;
                    
                    // Save the rate change to Google Sheets
                    const success = await saveRateAndDiscount(
                        clientName,
                        'תמחור שעה',
                        value,
                        monthSelect.value,
                        yearSelect.value
                    );
                    
                    if (!success) {
                        // Revert changes if save failed
                        this.textContent = formatNumber(oldValue, 2);
                        this.dataset.rawValue = oldValue;
                    }
                    
                    // Update total regardless of save success
                    updateTotal(row);
                });
                
                // Handle keydown for numbers and navigation
                cell.addEventListener('keydown', function(e) {
                    // Allow: backspace, delete, tab, escape, enter, numbers, decimal point
                    if ([46, 8, 9, 27, 13, 110, 190].includes(e.keyCode) ||
                        // Allow: Ctrl+A
                        (e.keyCode === 65 && e.ctrlKey === true) ||
                        // Allow: home, end, left, right
                        (e.keyCode >= 35 && e.keyCode <= 39) ||
                        // Allow: numbers
                        (e.keyCode >= 48 && e.keyCode <= 57) ||
                        // Allow: numpad numbers
                        (e.keyCode >= 96 && e.keyCode <= 105)) {
                        // Let it happen, don't do anything
                        return;
                    }
                    
                    // If it's not a number, prevent the keypress
                    if ((e.keyCode < 48 || e.keyCode > 57) && (e.keyCode < 96 || e.keyCode > 105) && e.keyCode !== 190 && e.keyCode !== 110) {
                        e.preventDefault();
                    }
                    
                    // Handle Enter key to save
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            }
            
            // Add event handlers for discount cells
            if (header === 'הנחה %') {
                cell.addEventListener('click', function() {
                    // Make cell editable
                    this.contentEditable = true;
                    // Show raw value without % when editing
                    this.textContent = this.dataset.rawValue || '0';
                    // Select all text for easy editing
                    const range = document.createRange();
                    range.selectNodeContents(this);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });
                
                // Handle blur event
                cell.addEventListener('blur', async function() {
                    const clientName = row.querySelector('.client-cell').textContent.trim();
                    const monthSelect = document.getElementById('monthSelect');
                    const yearSelect = document.getElementById('yearSelect');
                    
                    let value = parseFloat(this.textContent.trim()) || 0;
                    // Ensure value is between 0 and 100
                    value = Math.min(100, Math.max(0, value));
                    
                    // Store old value for potential rollback
                    const oldValue = this.dataset.rawValue || 0;
                    
                    // If value hasn't changed, just exit
                    if (Math.round(value) === Math.round(parseFloat(oldValue) || 0)) {
                        this.contentEditable = false;
                        this.textContent = `${Math.round(value)}%`;  // Ensure consistent formatting
                        return;
                    }
                    
                    // Round to nearest integer for display
                    const roundedValue = Math.round(value);
                    
                    // Update display with %
                    this.textContent = `${roundedValue}%`;
                    // Store raw value for calculations
                    this.dataset.rawValue = roundedValue;
                    this.contentEditable = false;
                    
                    // Save the discount change to Google Sheets
                    const success = await saveRateAndDiscount(
                        clientName,
                        'הנחה %',
                        roundedValue,
                        monthSelect.value,
                        yearSelect.value
                    );
                    
                    if (!success) {
                        // Revert changes if save failed
                        this.textContent = `${Math.round(oldValue)}%`;
                        this.dataset.rawValue = oldValue;
                    }
                    
                    // Update total regardless of save success
                    updateTotal(row);
                });
                
                // Handle keydown for numbers and navigation
                cell.addEventListener('keydown', function(e) {
                    // Allow: backspace, delete, tab, escape, enter, numbers, decimal point
                    if ([46, 8, 9, 27, 13, 110, 190].includes(e.keyCode) ||
                        // Allow: Ctrl+A
                        (e.keyCode === 65 && e.ctrlKey === true) ||
                        // Allow: home, end, left, right
                        (e.keyCode >= 35 && e.keyCode <= 39) ||
                        // Allow: numbers
                        (e.keyCode >= 48 && e.keyCode <= 57) ||
                        // Allow: numpad numbers
                        (e.keyCode >= 96 && e.keyCode <= 105)) {
                        // Let it happen, don't do anything
                        return;
                    }
                    
                    // If it's not a number, prevent the keypress
                    if ((e.keyCode < 48 || e.keyCode > 57) && (e.keyCode < 96 || e.keyCode > 105)) {
                        e.preventDefault();
                    }
                    
                    // Handle Enter key to save
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            }
            
            row.appendChild(cell);
        });
        
        tableBody.appendChild(row);
        
        // Function to update the total for a row
        function updateTotal(row) {
            try {
                const hoursCell = row.querySelector('td:nth-child(3)'); // סהכ שעות
                const rateCell = row.querySelector('td:nth-child(6)');  // תמחור שעה
                const discountCell = row.querySelector('td:nth-child(7)'); // הנחה %
                const totalCell = row.querySelector('td:nth-child(8)'); // סיכום
                
                if (hoursCell && rateCell && discountCell && totalCell) {
                    // Get hours from the cell text
                    const hours = parseFloat(hoursCell.textContent) || 0;
                    
                    // Get rate from data attribute if available, otherwise from cell text
                    let rate = parseFloat(rateCell.dataset.rawValue);
                    if (isNaN(rate)) {
                        rate = parseFloat(rateCell.textContent.replace(/[^0-9.-]+/g,"")) || 0;
                    }
                    
                    // Get discount from data attribute if available, otherwise from cell text
                    let discount = parseFloat(discountCell.dataset.rawValue);
                    if (isNaN(discount)) {
                        discount = parseFloat(discountCell.textContent) || 0;
                    }
                    
                    debugLog('Updating total with values:', { hours, rate, discount });
                    
                    // Calculate subtotal
                    const subtotal = hours * rate;
                    // Apply discount
                    const total = subtotal * (1 - (discount / 100));
                    
                    // Update total cell
                    totalCell.textContent = formatNumber(total, 2);
                    
                    // Update the cell's data attributes if they don't have them
                    if (!rateCell.dataset.rawValue) {
                        rateCell.dataset.rawValue = rate;
                    }
                    if (!discountCell.dataset.rawValue) {
                        discountCell.dataset.rawValue = discount;
                    }
                }
            } catch (error) {
                console.error('Error updating total:', error);
            }
        }
    });
}

// Helper function to format numbers with specific decimal places
// Shows whole numbers when decimal part is zero, otherwise shows 2 decimal places
function formatNumber(num, decimals) {
    if (num === undefined || num === null || num === '') return '';
    const number = parseFloat(num);
    if (isNaN(number)) return '';
    
    // Check if the number is a whole number
    if (number % 1 === 0) {
        return number.toLocaleString(undefined, {
            maximumFractionDigits: 0,
            minimumFractionDigits: 0
        });
    } else {
        // For numbers with decimal part, show exactly 2 decimal places
        return number.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
}

// Helper function to format cell content (for future use)
function formatCell(value) {
    if (value === undefined || value === null) return '';
    return String(value).replace(/\n/g, '<br>');
}

// Helper function to format currency values (for future use)
function formatCurrency(value) {
    if (value === undefined || value === null) return '';
    const num = parseFloat(value);
    return isNaN(num) ? '' : `₪${num.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

// Helper function to format percentage values (for future use)
function formatPercentage(value) {
    if (value === undefined || value === null) return '';
    const num = parseFloat(value);
    return isNaN(num) ? '' : `${num}%`;
}

// Function to show toast notification
function showToast(message, isError = false) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast' + (isError ? ' error' : '');
    
    // Show the toast
    setTimeout(() => toast.classList.add('show'), 10);
    
    // Hide the toast after 2 seconds
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2000);
}

// Function to save rate or discount changes to Google Sheets
async function saveRateAndDiscount(clientName, changeType, newValue, month, year) {
    try {
        const response = await fetch('/api/save_rate_discount', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                client_name: clientName,
                change_type: changeType,
                new_value: parseFloat(newValue) || 0,
                month: parseInt(month),
                year: parseInt(year)
            })
        });

        const result = await response.json();
        if (!result.success) {
            console.error('Error saving rate/discount:', result.error);
            // Show error toast
            showToast(`שגיאה בשמירת השינויים: ${result.error || 'שגיאה לא ידועה'}`, true);
            return false;
        }
        // Show success toast
        showToast(result.message || 'השינויים נשמרו בהצלחה!');
        return true;
    } catch (error) {
        console.error('Error saving rate/discount:', error);
        showToast('אירעה שגיאה בשמירת השינויים. נסה שוב.', true);
        return false;
    }
}

// Debug functions
function debugLog(message, data = null) {
    const timestamp = new Date().toISOString();
    const logEntry = document.createElement('div');
    logEntry.className = 'debug-entry';
    
    if (data) {
        logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
    } else {
        logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
    }
    
    const debugContent = document.getElementById('debugContent');
    if (debugContent) {
        debugContent.prepend(logEntry);
        // Keep only the last 50 log entries
        while (debugContent.children.length > 50) {
            debugContent.removeChild(debugContent.lastChild);
        }
    }
    
    // Also log to console
    if (data) {
        console.log(`[${timestamp}] ${message}`, data);
    } else {
        console.log(`[${timestamp}] ${message}`);
    }
}

function toggleDebug() {
    const debugPanel = document.getElementById('debugPanel');
    const toggleButton = document.getElementById('toggleDebug');
    
    if (debugPanel.style.display === 'none') {
        debugPanel.style.display = 'block';
        toggleButton.textContent = 'הסתר מידע ניפוי';
    } else {
        debugPanel.style.display = 'none';
        toggleButton.textContent = 'הצג מידע ניפוי';
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    debugLog('Billing page loaded');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    if (monthSelect && yearSelect) {
        // Set default values to current month and year
        const now = new Date();
        const currentMonth = now.getMonth() + 1;
        const currentYear = now.getFullYear();
        monthSelect.value = currentMonth;
        yearSelect.value = currentYear;
        // Load data when page loads
        await loadBillingData();
        // Add event listeners for month and year changes
        monthSelect.addEventListener('change', async function() {
            await loadBillingData();
        });
        yearSelect.addEventListener('change', async function() {
            await loadBillingData();
        });
    } else {
        console.error('Could not find month/year select elements');
        debugLog('Year select element not found', { error: 'element_not_found', id: 'yearSelect' });
    }
    // Set up event listeners for the export button
    const exportBtn = document.querySelector('.btn-export');
    if (exportBtn) {
        exportBtn.addEventListener('click', async function() {
            try {
                const monthSelect = document.getElementById('monthSelect');
                const yearSelect = document.getElementById('yearSelect');
                
                if (!monthSelect || !yearSelect) {
                    throw new Error('לא ניתן למצוא את בחירת החודש/שנה');
                }
                
                // Show loading state
                const originalText = exportBtn.textContent;
                exportBtn.disabled = true;
                exportBtn.textContent = 'מבצע ייצוא...';
                
                // Get the current billing data
                const response = await fetch(`/api/billing?month=${monthSelect.value}&year=${yearSelect.value}`);
                if (!response.ok) {
                    throw new Error('שגיאה בטעינת נתוני החיובים');
                }
                
                let data = await response.json();
                
                console.log('Starting export process...');
                
                // Get all table rows
                const tableBody = document.getElementById('billingTableBody');
                if (!tableBody) {
                    console.error('Billing table body not found');
                    throw new Error('Could not find billing table body');
                }
                
                const tableRows = tableBody.querySelectorAll('tr');
                console.log(`Found ${tableRows.length} rows in the table`);
                
                if (tableRows.length === 0) {
                    console.error('No data rows found in the table');
                    throw new Error('No data available to export');
                }
                
                // Collect data directly from the table
                const tableData = [];
                
                tableRows.forEach((row, rowIndex) => {
                    const cells = row.querySelectorAll('td');
                    console.log(`\n--- Processing row ${rowIndex + 1} ---`);
                    
                    if (cells.length < 8) {
                        console.warn(`Skipping row ${rowIndex + 1} - not enough cells (${cells.length})`);
                        return;
                    }
                    
                    // Get cell values
                    const rowData = {
                        'מספר': (rowIndex + 1).toString(),
                        'לקוח': cells[1]?.textContent?.trim() || '',
                        'סהכ שעות': parseFloat(cells[2]?.textContent?.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0,
                        'מדריך': cells[3]?.textContent?.trim() || '',
                        'לפי מדריך': cells[4]?.textContent?.trim() || '',
                        'תמחור שעה': cells[5]?.textContent?.trim() || '',
                        'הנחה %': parseFloat(cells[6]?.textContent?.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0,
                        'סיכום': cells[7]?.textContent?.trim() || ''
                    };
                    
                    // Log the extracted data for this row
                    console.log(`Row ${rowIndex + 1} data:`, rowData);
                    
                    tableData.push(rowData);
                });
                
                if (tableData.length === 0) {
                    throw new Error('No valid data found in the table');
                }
                
                console.log('Processed table data:', tableData);
                
                // Prepare export data
                const exportData = {
                    month: parseInt(monthSelect.value),
                    year: parseInt(yearSelect.value),
                    data: tableData
                };
                
                console.log('Sending export data:', exportData);
                
                // Debug: Log the final export data
                console.log('Final export data:', exportData);
                
                // Validate that we have data to export
                if (!exportData.data || exportData.data.length === 0) {
                    throw new Error('No valid data to export');
                }
                
                try {
                    // Send the export request
                    const exportResponse = await fetch('/api/export_billing', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(exportData)
                    });
                    
                    // Debug: Log the response status
                    console.log('Export response status:', exportResponse.status);
                    
                    if (!exportResponse.ok) {
                        const errorText = await exportResponse.text();
                        console.error('Export error response:', errorText);
                        throw new Error(`Server responded with status ${exportResponse.status}: ${errorText}`);
                    }
                    
                    const result = await exportResponse.json();
                    console.log('Export result:', result);
                    
                    if (result.success) {
                        const sheetName = result.message.split('to ')[1] || 'the spreadsheet';
                        alert(`הנתונים יוצאו בהצלחה לגיליון ${sheetName}`);
                        return result;
                    } else {
                        throw new Error(result.error || 'אירעה שגיאה בייצוא הנתונים');
                    }
                } catch (error) {
                    console.error('Error during export:', error);
                    throw error; // Re-throw to be caught by the outer catch block
                }
            } catch (error) {
                console.error('Export error:', error);
                alert(`שגיאה בייצוא לאקסל: ${error.message || 'אירעה שגיאה לא צפויה'}`);
            } finally {
                // Reset button state
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.textContent = 'ייצוא לאקסל';
                }
            }
        });
    } else {
        debugLog('Export button not found', { error: 'element_not_found', class: 'btn-export' });
    }
    // Remove the onchange attributes from the HTML to prevent duplicate handlers
    if (monthSelect) monthSelect.removeAttribute('onchange');
    if (yearSelect) yearSelect.removeAttribute('onchange');
    
    // Initialize client events functionality
    initClientEvents();
});

// Client Events Functionality
function initClientEvents() {
    // Add click handler for client cells
    document.addEventListener('click', function(e) {
        const clientCell = e.target.closest('.client-cell');
        if (clientCell && clientCell.textContent.trim()) {
            const clientName = clientCell.textContent.trim();
            showClientEvents(clientName);
        }
    });
    
    // Close modal when clicking the close button or outside the modal
    const modal = document.getElementById('clientEventsModal');
    const closeBtn = document.getElementById('closeClientEvents');
    const closeModalBtn = document.getElementById('closeModalBtn');
    
    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
    }
    
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
    }
    
    // Close when clicking outside the modal
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // Export to HTML button
    const exportBtn = document.getElementById('exportToHtml');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportEventsToHtml);
    }
}

async function showClientEvents(clientName) {
    const modal = document.getElementById('clientEventsModal');
    const title = document.getElementById('clientEventsTitle');
    const body = document.getElementById('clientEventsBody');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    
    if (!modal || !title || !body || !monthSelect || !yearSelect) {
        console.error('Required elements not found');
        return;
    }
    
    // Show loading state
    title.textContent = `טוען אירועים עבור ${clientName}...`;
    body.innerHTML = `
        <tr>
            <td colspan="5" style="text-align: center; padding: 20px;">
                <div class="loading-spinner"></div>
                <span class="loading-text">טוען אירועים...</span>
            </td>
        </tr>`;
    
    modal.style.display = 'block';
    
    try {
        // Fetch events for this client
        const response = await fetch(`/api/client_events?client_name=${encodeURIComponent(clientName)}&month=${monthSelect.value}&year=${yearSelect.value}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.status !== 'success' || !Array.isArray(result.data)) {
            throw new Error('Invalid response format');
        }
        
        // Update title with client name and event count
        title.textContent = `אירועים עבור ${clientName} (${result.data.length})`;
        
        if (result.data.length === 0) {
            body.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        לא נמצאו אירועים ללקוח זה בחודש הנבחר
                    </td>
                </tr>`;
            return;
        }
        
        // Sort events by start date (newest first)
        const sortedEvents = [...result.data].sort((a, b) => 
            new Date(a.start) - new Date(b.start)
        );
        
        // Render events
        body.innerHTML = sortedEvents.map(event => {
            const startDate = new Date(event.start);
            const endDate = new Date(event.end);
            
            // Format date as DD/MM/YYYY
            const formattedDate = startDate.toLocaleDateString('he-IL', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            // Format time as HH:MM-HH:MM
            const formattedStartTime = startDate.toLocaleTimeString('he-IL', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            
            const formattedEndTime = endDate.toLocaleTimeString('he-IL', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            
            return `
                <tr>
                    <td>${event.summary || ''}</td>
                    <td>${event.instructor || ''}</td>
                    <td>${formattedDate}</td>
                    <td>${formattedStartTime}-${formattedEndTime}</td>
                    <td>${event.duration_hours ? event.duration_hours.toFixed(2) : ''}</td>
                </tr>`;
        }).join('');
        
    } catch (error) {
        console.error('Error fetching client events:', error);
        title.textContent = `שגיאה בטעינת אירועים`;
        body.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; color: #d32f2f; padding: 20px;">
                    אירעה שגיאה בטעינת האירועים: ${error.message || 'שגיאה לא צפויה'}
                </td>
            </tr>`;
    }
}

function exportEventsToHtml() {
    const modal = document.getElementById('clientEventsModal');
    const title = document.getElementById('clientEventsTitle');
    const eventsTable = document.querySelector('.events-table');
    
    if (!modal || !title || !eventsTable) {
        console.error('Required elements not found for export');
        return;
    }
    
    try {
        // Create a clone of the table to avoid modifying the original
        const tableClone = eventsTable.cloneNode(true);
        
        // Create HTML content
        const htmlContent = `
            <!DOCTYPE html>
            <html dir="rtl">
            <head>
                <meta charset="UTF-8">
                <title>${title.textContent}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h1 { text-align: center; color: #333; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                    th { background-color: #f2f2f2; font-weight: bold; }
                    tr:nth-child(even) { background-color: #f9f9f9; }
                    .header { text-align: center; margin-bottom: 20px; }
                    .date { text-align: left; font-size: 0.9em; color: #666; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>${title.textContent}</h1>
                    <div class="date">נוצר בתאריך: ${new Date().toLocaleString('he-IL')}</div>
                </div>
                ${tableClone.outerHTML}
            </body>
            </html>`;
        
        // Create a blob and download link
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `אירועים_${title.textContent.replace(/[^\u0590-\u05FFa-zA-Z0-9_\-]/g, '_')}.html`;
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 100);
        
        showToast('הקובץ הורד בהצלחה');
        
    } catch (error) {
        console.error('Error exporting events:', error);
        showToast('אירעה שגיאה ביצירת הקובץ', true);
    }
}
</script>
{% endblock %}